""""
=============
Settings Window
=============

MS update 9/27: 
    1 did error checking for main settings tab; not checked offset, sweep_axis, and fixed_axis json variable, and positioner tab
Qs  2 changed json default values... if I click submit button, should the window close itself?
    3 created pop-up error message - ideally wanted to improve error detail in the future
    4 linear OR list frequency conditions met: can't input values on both
    5 list frequency conditions met: list must only be within 30 values and must be numbers within [0.030, 6000] MHz
    6 all blank input must be filled to do json tranfer with exception for buttons and drop down UI
"""""
import sys
from PyQt5 import QtWidgets as qtw
from PyQt5.QtWidgets import QMessageBox
from PyQt5 import uic
#from settingsWindow_form import Ui_SettingsWindow
import json
import re


baseUIClass, baseUIWidget = uic.loadUiType('settings_ui.ui')


class SettingsWindow(baseUIWidget, baseUIClass):

    def __init__(self):
        """MainWindow constructor"""
        super().__init__()
        self.setupUi(self)
        # Main UI code goes here
        self.pushButton_2.clicked.connect(self.check_json)  # End main UI code
        self.buttonBox.accepted.connect(self.check_json)
        self.show()

    def check_json(self):
        # properties of popup
        msg = QMessageBox()
        msg.setWindowTitle("Warning!")
        msg.setText("Input Error")
        msg.setIcon(QMessageBox.Critical)
        msg.setDetailedText("Will ideally show error details")
        # msg.exec_() # shows pop-up error

        # error checking
        if len(self.pos_alias_lineEdit_6.text()) > 0 and self.pos_alias_lineEdit_6.text().isnumeric():
            if len(self.lineEdit_list_5.text()) == 0:
                if (len(self.lineEdit_stop_4.text()) > 0 and len(self.lineEdit_start_4.text()) > 0 and
                        self.lineEdit_stop_4.text().isnumeric() and self.lineEdit_start_4.text().isnumeric()):
                    self.fill_json()
                else:
                    msg.exec_()
            elif re.search("^(( )*(([0-9]*\.([0-9]+))|[0-9]+))(,( )*(([0-9]*\.([0-9]+))|[0-9]+)){0,29}$",
                           self.lineEdit_list_5.text()):
                temp_ar = str(self.lineEdit_list_5.text()).split(",")

                if self.traverse(temp_ar, 0.03, 6000):  # check if list array values are [0.03, 6000] MHz
                    self.fill_json()
                else:
                    msg.exec_()
            else:
                msg.exec_()
        else:
            msg.exec_()

    def traverse(self, temp_list, low, high):
        for i in range(0, len(temp_list)):  # change list to integer
            temp_list[i] = float(temp_list[i])
        for x in temp_list:  # traverse in the list
            if x < low or x > high:  # condition check
                return False
        return True

    def fill_json(self):
        settings_dict = {
            "linear": {
                "start": None,
                "stop": None,
                "points": None
            },
            "list": None,
            "impedance": False,
            "calibration": False,
            "averaging": None,
            "positioner_mv": "step",
            "resolution": None,
            "gpib_addr": 16,
            "alias": None,
            "baud_rate": None,

            "offset": {
                "pan": None,
                "tilt": None
            },
            "sweep_axis": None,
            "fixed_angle": None
        }

        if len(self.lineEdit_stop_4.text()) > 0 and len(self.lineEdit_start_4.text()) > 0:
            settings_dict["linear"]["start"] = int(self.lineEdit_start_4.text())
            settings_dict["linear"]["stop"] = int(self.lineEdit_stop_4.text())
            settings_dict["linear"]["points"] = int(self.comboBox_4.currentText())

        if len(self.lineEdit_list_5.text()) > 0:
            settings_dict["list"] = str(self.lineEdit_list_5.text()).split(",")
            for i in range(0, len(settings_dict["list"])):
                settings_dict["list"][i] = float(settings_dict["list"][i])

        if self.Impedance_radioButton_y_7.isChecked():
            settings_dict["impedance"] = True

        if self.Calibration_radioButton_y_7.isChecked():
            settings_dict["calibration"] = True

        settings_dict["averaging"] = int(self.Averaging_comboBox_7.currentText())

        if self.cont_radioButton_7.isChecked():
            settings_dict["positioner_mv"] = "continuous"

        settings_dict["resolution"] = self.res_doubleSpinBox_7.value()
        settings_dict["gpib_addr"] = int(self.GPIB_addr_comboBox_6.currentText())
        settings_dict["alias"] = int(self.pos_alias_lineEdit_6.text())
        settings_dict["baud_rate"] = int(self.BaudRate_comboBox_6.currentText())

        settings_dict["offset"]["pan"] = self.pan_lcdNumber_4.intValue()
        settings_dict["offset"]["tilt"] = self.tilt_lcdNumber_4.intValue()
        settings_dict["sweep_axis"] = "pan"
        settings_dict["fixed_angle"] = self.AngleOffdoubleSpinBox_2.value()

        with open("pivot.json", "w") as file:
            json.dump(settings_dict, file, indent = 2)


if __name__ == '__main__':
    app = qtw.QApplication(sys.argv)
    sw = SettingsWindow()
    sys.exit(app.exec())
